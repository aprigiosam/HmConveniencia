# üñ®Ô∏è FASE 2 - Hardware e Perif√©ricos

Documenta√ß√£o da implementa√ß√£o de suporte a hardware e perif√©ricos para PDV.

## üìã √çndice

- [Impressora T√©rmica](#impressora-t√©rmica)
- [Leitor de C√≥digo de Barras](#leitor-de-c√≥digo-de-barras)
- [Balan√ßa Digital](#balan√ßa-digital-planejado)
- [Como Usar](#como-usar)
- [Troubleshooting](#troubleshooting)

---

## üñ®Ô∏è Impressora T√©rmica

### **Implementado**

Sistema completo de impress√£o t√©rmica com suporte a protocolo ESC/POS.

### **Funcionalidades**

‚úÖ **M√∫ltiplos Modos de Conex√£o**:
- **WebUSB**: Conex√£o direta via navegador (Chrome/Edge)
- **Rede**: Impressora de rede via IP
- **Servidor Local**: Proxy/servidor intermedi√°rio

‚úÖ **Comandos ESC/POS Completos**:
- Inicializa√ß√£o
- Alinhamento (esquerda, centro, direita)
- Negrito, sublinhado
- Texto duplo (altura/largura)
- Corte de papel
- Feed de papel
- QR Code
- C√≥digo de barras

‚úÖ **Templates de Impress√£o**:
- Cupom de venda completo
- Cabe√ßalho customiz√°vel
- Listagem de itens
- Totais e descontos
- Formas de pagamento
- Rodap√© com data/hora

‚úÖ **Recursos Avan√ßados**:
- Configura√ß√£o persistente (localStorage)
- Hook React customizado
- Componente de configura√ß√£o visual
- Teste de impress√£o
- Tratamento de erros

### **Arquivos Criados**

1. `/frontend/src/utils/printer.ts` - Classe ThermalPrinter
2. `/frontend/src/hooks/usePrinter.ts` - Hook de gerenciamento
3. `/frontend/src/components/PrinterSettings.tsx` - UI de configura√ß√£o

### **Como Usar**

#### **1. Configurar Impressora**

```tsx
import { PrinterSettings } from './components/PrinterSettings';

function SettingsPage() {
  return <PrinterSettings />;
}
```

#### **2. Usar no C√≥digo**

```tsx
import { usePrinter } from './hooks/usePrinter';

function POSPage() {
  const { printReceipt, isPrinting } = usePrinter();

  const handleFinalizeSale = async (sale) => {
    const receipt = {
      header: {
        storeName: 'Minha Loja',
        address: 'Rua Example, 123',
        phone: '(11) 1234-5678',
        cnpj: '12.345.678/0001-90',
      },
      items: sale.items.map(item => ({
        description: item.name,
        quantity: item.quantity,
        price: item.price,
        total: item.total,
      })),
      subtotal: sale.subtotal,
      discount: sale.discount,
      total: sale.total,
      payments: sale.payments,
      footer: {
        message: 'Obrigado pela prefer√™ncia!',
        date: new Date(),
        orderNumber: sale.orderNumber,
      },
    };

    const success = await printReceipt(receipt);
    if (success) {
      console.log('Cupom impresso!');
    }
  };

  return (
    <button onClick={handleFinalizeSale} disabled={isPrinting}>
      {isPrinting ? 'Imprimindo...' : 'Finalizar Venda'}
    </button>
  );
}
```

### **Impressoras Suportadas**

| Marca | Modelos | Status |
|-------|---------|--------|
| **Epson** | TM-T20, TM-T88, TM-T81 | ‚úÖ Testado |
| **Bematech** | MP-4200, MP-100, MP-2100 | ‚úÖ Compat√≠vel |
| **Elgin** | i7, i9, i10 | ‚úÖ Compat√≠vel |
| **Star Micronics** | TSP100, TSP650 | ‚úÖ Compat√≠vel |
| **Outras ESC/POS** | Gen√©ricas | ‚ö†Ô∏è Testar |

### **Configura√ß√£o WebUSB**

Para usar WebUSB (recomendado):

1. **Navegador**: Chrome 61+ ou Edge 79+
2. **HTTPS**: Necess√°rio (exceto localhost)
3. **Permiss√µes**: Usu√°rio deve autorizar acesso USB

#### **Conectar via WebUSB**

```typescript
const { connect, isConnected } = usePrinter();

// Bot√£o para conectar
<button onClick={connect}>
  {isConnected ? 'Conectada' : 'Conectar Impressora'}
</button>
```

### **Configura√ß√£o Rede**

Para impressora de rede:

1. Configure o IP fixo na impressora
2. Anote a porta (padr√£o: 9100)
3. Configure no sistema:

```typescript
configurePrinter({
  type: 'network',
  ipAddress: '192.168.1.100',
  port: 9100,
});
```

‚ö†Ô∏è **Importante**: Devido a restri√ß√µes de CORS, pode ser necess√°rio um proxy/servidor intermedi√°rio.

### **Configura√ß√£o Servidor Local**

Para m√°xima compatibilidade, use um servidor local:

#### **Op√ß√£o 1: Node.js Simple Print Server**

```bash
# Instalar
npm install -g simple-print-server

# Executar
simple-print-server --port 9100
```

#### **Op√ß√£o 2: Python Print Server (Inclu√≠do)**

```bash
# Backend j√° inclui endpoint
cd backend
python manage.py runserver

# Impressora responde em:
# http://localhost:8000/api/v1/hardware/print/
```

Configure no frontend:

```typescript
configurePrinter({
  type: 'local-server',
  serverUrl: 'http://localhost:8000/api/v1/hardware/print/',
});
```

---

## üìü Leitor de C√≥digo de Barras

### **Implementado**

Sistema aprimorado de detec√ß√£o de leitores de c√≥digo de barras com diferencia√ß√£o de digita√ß√£o manual.

### **Melhorias da FASE 2**

‚úÖ **Detec√ß√£o Inteligente**:
- Diferencia scanner de digita√ß√£o manual (velocidade)
- Buffer com timeout configur√°vel
- Prefixo/sufixo configur√°vel

‚úÖ **Configura√ß√µes Avan√ßadas**:
- Tamanho m√≠nimo/m√°ximo do c√≥digo
- Ignorar inputs espec√≠ficos
- Marca√ß√£o de inputs permitidos (`data-allow-scanner`)
- Limpeza autom√°tica de buffer

‚úÖ **Feedback Visual**:
- Console logs para debug
- Aviso de c√≥digos inv√°lidos

### **Como Usar**

#### **Uso Global (Recomendado)**

```tsx
import { useBarcodeScanner } from './hooks/useBarcodeScanner';

function POSPage() {
  const { addProductByCode } = useProductSearch();

  useBarcodeScanner({
    enabled: true,
    minLength: 8,    // EAN-8 m√≠nimo
    maxLength: 14,   // EAN-14 m√°ximo
    timeout: 100,    // 100ms entre caracteres
    onScan: (code) => {
      console.log('C√≥digo escaneado:', code);
      addProductByCode(code);
    },
    ignoreInputs: true, // Ignora quando foco est√° em inputs
  });

  return <div>Seu PDV aqui</div>;
}
```

#### **Input Espec√≠fico Permitido**

```tsx
<input
  type="text"
  placeholder="Escaneie ou digite o c√≥digo"
  data-allow-scanner  // Permite scanner mesmo com ignoreInputs=true
  className="..."
/>
```

#### **Configura√ß√£o Customizada**

```tsx
useBarcodeScanner({
  enabled: true,
  minLength: 4,
  maxLength: 50,
  timeout: 100,     // ms entre caracteres para considerar scan
  prefix: '',       // Prefixo opcional do scanner
  suffix: 'Enter',  // Sufixo (geralmente Enter)
  ignoreInputs: false,
  onScan: (code) => {
    // Processar c√≥digo
  },
});
```

### **Leitores Suportados**

| Tipo | Compatibilidade |
|------|-----------------|
| **USB HID** (Keyboard Emulation) | ‚úÖ 100% |
| **USB Serial** | ‚ö†Ô∏è Requer driver |
| **Bluetooth** | ‚úÖ Se emular teclado |
| **Wireless** | ‚úÖ Se emular teclado |

### **Troubleshooting Scanner**

#### **Scanner n√£o funciona**

1. **Verificar modo**: Scanner deve estar em modo "Keyboard Emulation" ou "HID"
2. **Testar manualmente**: Digite um c√≥digo e pressione Enter
3. **Console logs**: Veja se aparecem logs `üìü C√≥digo de barras escaneado`
4. **Timeout**: Ajuste o par√¢metro `timeout` (50-200ms)

#### **Caracteres faltando**

- Aumente o `timeout` para 150-200ms
- Verifique se scanner est√° em modo r√°pido

#### **C√≥digos duplicados**

- Buffer sendo processado duas vezes
- Verifique se n√£o h√° m√∫ltiplos hooks ativos

---

## ‚öñÔ∏è Balan√ßa Digital (Planejado)

### **Status**: üöß Em desenvolvimento

Suporte a balan√ßas digitais via:
- Serial/USB
- Protocolo Toledo
- Protocolo Filizola

**Previs√£o**: FASE 2 - Parte 2

---

## üîß Como Usar

### **Setup Inicial**

1. **Instalar depend√™ncias** (j√° inclu√≠das):
```bash
cd frontend
npm install
```

2. **Configurar impressora**:
   - Acesse Configura√ß√µes ‚Üí Hardware ‚Üí Impressora
   - Escolha o tipo de conex√£o
   - Teste a impress√£o

3. **Configurar scanner**:
   - Nenhuma configura√ß√£o necess√°ria (auto-detecta)
   - Opcional: Ajustar par√¢metros no c√≥digo

### **Integra√ß√£o no PDV**

```tsx
import { usePrinter } from './hooks/usePrinter';
import { useBarcodeScanner } from './hooks/useBarcodeScanner';

function POSPage() {
  const { printReceipt } = usePrinter();
  const { addProduct } = useCart();

  // Scanner autom√°tico
  useBarcodeScanner({
    enabled: true,
    onScan: (code) => addProduct(code),
  });

  const handleFinalize = async (sale) => {
    // Imprime cupom
    await printReceipt(sale);
  };

  return <div>{/* Seu PDV */}</div>;
}
```

---

## üêõ Troubleshooting

### **Impressora WebUSB n√£o conecta**

**Problemas comuns**:
1. ‚úÖ Usar Chrome/Edge (Firefox n√£o suporta)
2. ‚úÖ Usar HTTPS ou localhost
3. ‚úÖ Impressora ligada e conectada via USB
4. ‚úÖ Drivers instalados no sistema

**Solu√ß√£o alternativa**: Use servidor local

### **Impressora imprime caracteres estranhos**

**Causas**:
- Encoding incorreto
- Impressora n√£o suporta ESC/POS

**Solu√ß√£o**:
1. Verificar se impressora √© ESC/POS
2. Tentar encoding diferente (UTF-8 vs CP850)

### **Scanner n√£o detecta c√≥digos**

**Verifica√ß√µes**:
1. ‚úÖ Scanner em modo "Keyboard"
2. ‚úÖ Testar digitando manualmente + Enter
3. ‚úÖ Console do navegador (F12) mostrando logs
4. ‚úÖ Ajustar `timeout` e `minLength`

### **P√°gina n√£o carrega depois de adicionar hardware**

**Verificar**:
- Erros no console do navegador
- Imports corretos dos hooks
- TypeScript compilando sem erros

---

## üìä Compara√ß√£o com Odoo POS

| Recurso | Odoo POS | Antes | **Agora (FASE 2)** |
|---------|----------|-------|---------------------|
| Impressora ESC/POS | ‚úÖ | ‚ùå | **‚úÖ** |
| WebUSB | ‚úÖ | ‚ùå | **‚úÖ** |
| Rede/Serial | ‚úÖ | ‚ùå | **‚úÖ** |
| Templates Customiz√°veis | ‚úÖ | ‚ùå | **‚úÖ** |
| Scanner Barcode | ‚úÖ | ‚ö†Ô∏è B√°sico | **‚úÖ Aprimorado** |
| Balan√ßa Digital | ‚úÖ | ‚ùå | üöß Planejado |
| Customer Display | ‚úÖ | ‚ùå | üöß Planejado |

---

## üéØ Pr√≥ximos Passos

### **FASE 2 - Parte 2** (Pendente)

- [ ] Fila de impress√£o
- [ ] Balan√ßa digital
- [ ] Customer display secund√°rio
- [ ] Configura√ß√µes de hardware persistentes
- [ ] Gaveta de dinheiro (cash drawer)

### **FASE 3 - Relat√≥rios**
- [ ] Relat√≥rio de fechamento impresso
- [ ] Relat√≥rio X (parcial)
- [ ] Relat√≥rio Z (fechamento)
- [ ] Sangria/Suprimento detalhado

---

## üìö Refer√™ncias

- [ESC/POS Command Reference](https://reference.epson-biz.com/modules/ref_escpos/index.php)
- [WebUSB API](https://developer.mozilla.org/en-US/docs/Web/API/WebUSB_API)
- [Barcode Scanner Integration](https://www.npmjs.com/package/react-barcode-reader)

---

**üéâ Seu sistema agora tem suporte profissional a hardware!**